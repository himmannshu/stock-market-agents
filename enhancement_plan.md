# Financial Research Agent Enhancement Plan

## Current State (As of 2024-XX-XX)

*   **Core Functionality**: The system takes a natural language query about a company, retrieves financial data and web search results, synthesizes them into a report, and verifies the report.
*   **Agents**:
    *   `planner_agent`: Creates search terms.
    *   `search_agent`: Executes web searches (using `WebSearchTool`).
    *   `financial_data_agent`: Retrieves structured financial data (using `financial_data_search` tool) and performs initial analysis.
    *   `financials_agent`: Sub-agent for fundamental analysis (available as a tool to the writer).
    *   `risk_agent`: Sub-agent for risk analysis (available as a tool to the writer).
    *   `writer_agent`: Synthesizes all gathered information into a final report.
    *   `verifier_agent`: Checks the final report for consistency.
    *   `FinancialResearchManager`: Orchestrates the overall workflow.
*   **Tools**:
    *   `WebSearchTool`: Used by `search_agent`.
    *   `financial_data_search` (Custom Function Tool): Used by `financial_data_agent`. Fetches:
        *   Company Info (`/company`)
        *   Historical Metrics (`/financial-metrics`, default: 3 annual periods)
        *   Financial Statements (`/financials/*`, latest annual)
        *   Segmented Revenues (`/financials/segmented-revenues`, latest annual)
        *   Stock Price (`/prices`, latest daily)
        *   Earnings Press Release (`/earnings/press-releases`, latest)
    *   `financials_agent` (as tool)
    *   `risk_agent` (as tool)
*   **Output Format**:
    *   `financial_data_search` tool returns a Markdown formatted string summarizing the data.
    *   Final output is a Markdown report generated by `writer_agent`.
*   **Configuration**: Uses `.env` for API keys (OpenAI, Financial Datasets). `ModelSettings` from SDK used to force tool choice where needed.

## Enhancement Status & Roadmap (As of YYYY-MM-DD - *Please update date*)

This section outlines completed enhancements and a roadmap for future improvements.

### Phase 1: Adding Core Data Endpoints (âœ… Completed)

*   **SEC Filings:** Added `_get_sec_filings`, updated `financial_data_search`, added 'sec-filings' type, added formatting in `_format_financial_data`.
*   **Company News:** Added `_get_company_news`, updated `financial_data_search`, added 'news' type, added formatting.
*   **Insider Trades:** Added `_get_insider_trades`, updated `financial_data_search`, added 'insider-trades' type, added formatting.
*   **Institutional Ownership:** Added `_get_institutional_ownership`, updated `financial_data_search`, added 'institutional-ownership' type, added formatting.
*   **API Endpoint Correction:** Corrected `/financial-metrics` endpoint to `/financial-metrics`.

### Phase 2: Preparing for Visualization & Refining Agents (ðŸš§ Partially Completed / In Progress)

*   **Refine Synthesis & Verification Prompts:** ðŸš§ In Progress.
    *   Prompts for `financial_data_agent` and `writer_agent` enhanced multiple times to explicitly request more detail, specific numbers/figures, deeper synthesis, and analysis of implications.
    *   *Current Issue:* Reports still perceived as lacking sufficient depth despite prompt improvements. Further iteration needed.

### Phase 3: Web Interface Integration (ðŸš§ Partially Completed / In Progress)

*   **Setup Streamlit App:** âœ… Completed (`streamlit_app.py` created).
*   **Develop Core Web App:** âœ… Completed (Basic UI, manager integration).
    *   Manager refactored to return results dictionary.
    *   Streamlit app displays Markdown report, follow-ups, and verification.

---

## Proposed Next Steps & Roadmap

This roadmap addresses current issues and incorporates requested features.

**Step 1: Stabilize Current Features & Debug Issues**

1.  **Iteratively Improve Report Depth:**
    *   **Goal:** Address the core issue of reports lacking analytical depth despite prompt enhancements.
    *   **Tasks:**
        *   **Analyze Agent I/O:** Manually inspect the detailed textual context (`financial_data_text_context`) being passed *into* the `writer_agent` vs. the final `markdown_report` it produces. Is the detail being lost during synthesis?
        *   **Targeted Prompt Experiments (Writer):** Try different phrasing, emphasize analytical connections ("Explain the implication of...", "Compare X to Y..."), potentially ask for specific quantitative comparisons if data allows. Consider few-shot examples in the prompt.
        *   **Targeted Prompt Experiments (Data Agent):** Ensure `financial_data_agent` is consistently extracting *all* relevant textual details (specific numbers, dates etc.) from the tool output into its summary fields. Add checks or logging if needed.
        *   **Consider Agent Structure:** If prompt tuning hits a limit, consider if a different agent structure (e.g., breaking down the writer's task further) might be needed, but try prompt refinement first.

**Step 2: Core Feature Enhancements**

2.  **Save Report Locally:**
    *   **Goal:** Allow users to save the generated report as a local Markdown file.
    *   **Tasks:** Add a button in `streamlit_app.py`. When clicked, take the `final_markdown_report` string and write it to a `.md` file (e.g., `report_{ticker}_{timestamp}.md`).
3.  **Enhance News Presentation:**
    *   **Goal:** Make recent news more prominent and useful.
    *   **Tasks:**
        *   Modify `streamlit_app.py` to potentially display the top 3-5 news headlines (from `financial_data_agent`'s `news_summary` or by parsing the tool output again) in a dedicated, easily readable section (e.g., using `st.info` or bullet points) near the top, separate from the main report body.
        *   Alternatively, enhance the `writer_agent` prompt to specifically structure a "Recent News Headlines" section within its report.
4.  **Implement Report Download:**
    *   **Goal:** Allow users to download the generated report directly from the browser.
    *   **Tasks:** Use `st.download_button` in `streamlit_app.py`, providing the `final_markdown_report` string as the data, a suitable filename, and `text/markdown` as the MIME type.

**Step 3: UI/UX Improvements**

5.  **Implement Real-time Status Updates:**
    *   **Goal:** Provide users with feedback on the agent's progress within the Streamlit UI.
    *   **Tasks:**
        *   Refactor the `Printer` class or the `FinancialResearchManager` methods (`_get_financial_data`, `_perform_searches`, `_write_report`, etc.).
        *   Instead of printing updates, use `st.status` or yield status messages back to `streamlit_app.py` to update `status_placeholder.info(...)` dynamically.
6.  **Refine UI Layout:**
    *   **Goal:** Improve the organization and readability of the results page.
    *   **Tasks:** Use `st.tabs` to separate the main "Report", "Follow-Up Questions", and "Verification Details". Use `st.expander` within tabs if needed.
7.  **Add Basic Configuration:**
    *   **Goal:** Allow users some control over the data retrieval.
    *   **Tasks:** Add widgets (e.g., `st.selectbox`, `st.slider`) to `streamlit_app.py` to allow users to select the period (`annual`, `quarterly`) or limit for metrics/prices (passed down to the `manager`).

**Step 4: Advanced Enhancements (Future Considerations)**

8.  **Comparative Analysis:** Add functionality (new agent/tool) to compare the target company's key metrics against industry peers or benchmarks.
9.  **Sentiment Analysis:** Integrate a sentiment scoring model for the news summary to provide a quantitative sentiment indicator.
10. **Enhanced Verification:** Improve the `verifier_agent` prompt to perform more specific checks.
11. **Caching:** Implement caching for API calls (e.g., using `st.cache_data` or a database) to reduce costs and speed up repeated queries.
12. **PDF Report Generation:** Add an option to download the report as a formatted PDF.
13. **More Sophisticated Query Handling:** Use NLP/LLM to reliably extract the ticker/company and potentially understand more complex queries (e.g., "Compare Apple and Microsoft's cloud revenue growth").

This updated plan provides a clearer picture of where we are and a structured approach to improving the application. 