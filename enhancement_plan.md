# Financial Research Agent Enhancement Plan

## Current State (As of 2024-XX-XX)

*   **Core Functionality**: The system takes a natural language query about a company, retrieves financial data and web search results, synthesizes them into a report, and verifies the report.
*   **Agents**:
    *   `planner_agent`: Creates search terms.
    *   `search_agent`: Executes web searches (using `WebSearchTool`).
    *   `financial_data_agent`: Retrieves structured financial data (using `financial_data_search` tool) and performs initial analysis.
    *   `financials_agent`: Sub-agent for fundamental analysis (available as a tool to the writer).
    *   `risk_agent`: Sub-agent for risk analysis (available as a tool to the writer).
    *   `writer_agent`: Synthesizes all gathered information into a final report.
    *   `verifier_agent`: Checks the final report for consistency.
    *   `FinancialResearchManager`: Orchestrates the overall workflow.
*   **Tools**:
    *   `WebSearchTool`: Used by `search_agent`.
    *   `financial_data_search` (Custom Function Tool): Used by `financial_data_agent`. Fetches:
        *   Company Info (`/company`)
        *   Historical Metrics (`/metrics/historical`, default: 3 annual periods)
        *   Financial Statements (`/financials/*`, latest annual)
        *   Segmented Revenues (`/financials/segmented-revenues`, latest annual)
        *   Stock Price (`/prices`, latest daily)
        *   Earnings Press Release (`/earnings/press-releases`, latest)
    *   `financials_agent` (as tool)
    *   `risk_agent` (as tool)
*   **Output Format**:
    *   `financial_data_search` tool returns a Markdown formatted string summarizing the data.
    *   Final output is a Markdown report generated by `writer_agent`.
*   **Configuration**: Uses `.env` for API keys (OpenAI, Financial Datasets). `ModelSettings` from SDK used to force tool choice where needed.

## Proposed Enhancements Plan

This plan outlines adding more data endpoints from the Financial Datasets API and refining the output and agent prompts.

### Phase 1: Adding Core Data Endpoints (GET Requests)

1.  **Add SEC Filings:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_sec_filings(ticker, limit)` helper function targeting `/filings`.
        *   Update `financial_data_search` parameters to include optional `filings_limit: Optional[int] = None` (default 5).
        *   Add `'sec-filings'` to `valid_data_types` list.
        *   Call `_get_sec_filings` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add a "Recent SEC Filings" section.
        *   Format output as a Markdown table listing the latest filings (e.g., Filing Type, Report Date, URL).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt slightly to mention availability of SEC filings data.

2.  **Add Company News:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_company_news(ticker, limit)` helper function targeting `/news`.
        *   Update `financial_data_search` parameters to include optional `news_limit: Optional[int] = None` (default 5).
        *   Add `'news'` to `valid_data_types` list.
        *   Call `_get_company_news` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add a "Recent News" section (potentially near the top).
        *   Format output as a list (e.g., `* [YYYY-MM-DD]: Headline (Source)`).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt to explicitly instruct the agent to consider recent news headlines and sentiment in its analysis.
        *   Update `FinancialDataAnalysis` output model if a specific news summary field is desired.
    *   **Agent (`writer_agent.py`):**
        *   Update prompt to incorporate news context into the final report.

3.  **Add Insider Trades:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_insider_trades(ticker, limit)` helper function targeting `/insider-trades`.
        *   Update `financial_data_search` parameters to include optional `insider_trades_limit: Optional[int] = None` (default 10).
        *   Add `'insider-trades'` to `valid_data_types` list.
        *   Call `_get_insider_trades` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add a "Recent Insider Trades" section.
        *   Format output as a Markdown table summarizing trades (e.g., Date, Insider Name, Relationship, Transaction Type, Shares, Value).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt to instruct the agent to analyze potential patterns or significance of recent insider trades.
        *   Update `FinancialDataAnalysis` output model if a specific insider trade summary field is desired.

4.  **Add Institutional Ownership:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_institutional_ownership(ticker, limit)` helper function targeting `/institutional-ownership`. (Need to verify exact endpoint/parameters from docs if `/investor` path is specific).
        *   Update `financial_data_search` parameters to include optional `inst_ownership_limit: Optional[int] = None` (default 10).
        *   Add `'institutional-ownership'` to `valid_data_types` list.
        *   Call `_get_institutional_ownership` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add an "Institutional Ownership" section.
        *   Format output to list top holders (e.g., Holder Name, Shares Held, % Ownership, Reported Date).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt to mention ownership data availability.

### Phase 2: Advanced Features & Refinements

5.  **(Advanced) Add Financial Search Endpoint:**
    *   Investigate modifying `_make_request` or adding `_make_post_request` for POST calls.
    *   Design how the `financial_data_agent` would construct filter criteria based on a query. This likely requires significant prompt engineering or a separate filter-generating step.
    *   Update `financial_data_search` tool parameters to accept filter structures.
    *   Implement formatting for generic search results.
    *   *Decision*: Defer due to complexity.

6.  **(Advanced) Add Visual Charts:**
    *   Investigate options: Markdown tables suitable for copy/pasting, links to external charting tools, or more complex integrations.
    *   *Decision*: Defer initial implementation. Focus on providing raw data clearly first. Can revisit generating chart-friendly tables later.

7.  **Refine Agent Prompts & Synthesis:**
    *   After adding multiple data sources, review and significantly enhance the prompts for `financial_data_agent` and `writer_agent`.
    *   Focus on instructing the agents how to *synthesize* information from *all* sources (news, filings, trades, ownership, financials, web search) rather than just listing them.
    *   Ensure the `FinancialDataAnalysis` and `FinancialReportData` output models effectively capture the desired level of synthesized analysis.

8.  **Testing:** Thoroughly test after each endpoint addition and major prompt change. 