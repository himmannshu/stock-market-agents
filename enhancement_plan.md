# Financial Research Agent Enhancement Plan

## Current State (As of 2024-XX-XX)

*   **Core Functionality**: The system takes a natural language query about a company, retrieves financial data and web search results, synthesizes them into a report, and verifies the report.
*   **Agents**:
    *   `planner_agent`: Creates search terms.
    *   `search_agent`: Executes web searches (using `WebSearchTool`).
    *   `financial_data_agent`: Retrieves structured financial data (using `financial_data_search` tool) and performs initial analysis.
    *   `financials_agent`: Sub-agent for fundamental analysis (available as a tool to the writer).
    *   `risk_agent`: Sub-agent for risk analysis (available as a tool to the writer).
    *   `writer_agent`: Synthesizes all gathered information into a final report.
    *   `verifier_agent`: Checks the final report for consistency.
    *   `FinancialResearchManager`: Orchestrates the overall workflow.
*   **Tools**:
    *   `WebSearchTool`: Used by `search_agent`.
    *   `financial_data_search` (Custom Function Tool): Used by `financial_data_agent`. Fetches:
        *   Company Info (`/company`)
        *   Historical Metrics (`/metrics/historical`, default: 3 annual periods)
        *   Financial Statements (`/financials/*`, latest annual)
        *   Segmented Revenues (`/financials/segmented-revenues`, latest annual)
        *   Stock Price (`/prices`, latest daily)
        *   Earnings Press Release (`/earnings/press-releases`, latest)
    *   `financials_agent` (as tool)
    *   `risk_agent` (as tool)
*   **Output Format**:
    *   `financial_data_search` tool returns a Markdown formatted string summarizing the data.
    *   Final output is a Markdown report generated by `writer_agent`.
*   **Configuration**: Uses `.env` for API keys (OpenAI, Financial Datasets). `ModelSettings` from SDK used to force tool choice where needed.

## Proposed Enhancements Plan

This plan outlines adding more data endpoints from the Financial Datasets API and refining the output and agent prompts.

### Phase 1: Adding Core Data Endpoints (GET Requests)

1.  **Add SEC Filings:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_sec_filings(ticker, limit)` helper function targeting `/filings`.
        *   Update `financial_data_search` parameters to include optional `filings_limit: Optional[int] = None` (default 5).
        *   Add `'sec-filings'` to `valid_data_types` list.
        *   Call `_get_sec_filings` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add a "Recent SEC Filings" section.
        *   Format output as a Markdown table listing the latest filings (e.g., Filing Type, Report Date, URL).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt slightly to mention availability of SEC filings data.

2.  **Add Company News:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_company_news(ticker, limit)` helper function targeting `/news`.
        *   Update `financial_data_search` parameters to include optional `news_limit: Optional[int] = None` (default 5).
        *   Add `'news'` to `valid_data_types` list.
        *   Call `_get_company_news` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add a "Recent News" section (potentially near the top).
        *   Format output as a list (e.g., `* [YYYY-MM-DD]: Headline (Source)`).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt to explicitly instruct the agent to consider recent news headlines and sentiment in its analysis.
        *   Update `FinancialDataAnalysis` output model if a specific news summary field is desired.
    *   **Agent (`writer_agent.py`):**
        *   Update prompt to incorporate news context into the final report.

3.  **Add Insider Trades:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_insider_trades(ticker, limit)` helper function targeting `/insider-trades`.
        *   Update `financial_data_search` parameters to include optional `insider_trades_limit: Optional[int] = None` (default 10).
        *   Add `'insider-trades'` to `valid_data_types` list.
        *   Call `_get_insider_trades` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add a "Recent Insider Trades" section.
        *   Format output as a Markdown table summarizing trades (e.g., Date, Insider Name, Relationship, Transaction Type, Shares, Value).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt to instruct the agent to analyze potential patterns or significance of recent insider trades.
        *   Update `FinancialDataAnalysis` output model if a specific insider trade summary field is desired.

4.  **Add Institutional Ownership:**
    *   **Tool (`financial_data_tool.py`):**
        *   Create `_get_institutional_ownership(ticker, limit)` helper function targeting `/institutional-ownership`. (Need to verify exact endpoint/parameters from docs if `/investor` path is specific).
        *   Update `financial_data_search` parameters to include optional `inst_ownership_limit: Optional[int] = None` (default 10).
        *   Add `'institutional-ownership'` to `valid_data_types` list.
        *   Call `_get_institutional_ownership` when requested.
    *   **Formatting (`_format_financial_data`):**
        *   Add an "Institutional Ownership" section.
        *   Format output to list top holders (e.g., Holder Name, Shares Held, % Ownership, Reported Date).
    *   **Agent (`financial_data_agent.py`):**
        *   Update prompt to mention ownership data availability.

### Phase 2: Preparing for Visualization & Advanced Features

5.  **(Data for Charts) Enhance Tool Output for Visualization:**
    *   **Goal**: Prepare data within the agent workflow that can be easily parsed and visualized on the future webpage.
    *   **Tool (`financial_data_tool.py`):**
        *   Modify `_get_stock_prices` to fetch a longer history (e.g., 90 days).
        *   Modify `_get_company_metrics` to return *all* periods fetched (not just the latest) if `metrics` or `all` is requested.
        *   Modify `_format_financial_data`: 
            *   Keep the existing Markdown *textual summaries* for LLM consumption.
            *   **Add** separate sections containing structured data intended for charts. Embed this data as CSV or JSON within Markdown code blocks (e.g., ```csv ... ``` or ```json ... ```). Include data like historical prices (Date, Close) and key historical metrics time series (Year, Period, Metric1, Metric2...). 
    *   **Agent (`financial_data_agent.py`):**
        *   Ensure prompt clarifies that the agent should base its *analysis* primarily on the textual summary parts of the tool output, largely ignoring the raw data blocks intended for charts (as these are for the frontend).
    *   **Agent (`writer_agent.py`):**
        *   Ensure prompt instructs the agent to pass through the structured data blocks (CSV/JSON) from the tool output into the final report *without alteration or interpretation*, alongside its textual analysis. These blocks act as data payloads for the frontend.

6.  **(Advanced/Deferred) Add Financial Search Endpoint:**
    *   Requires POST requests and complex filter generation. Defer.

7.  **Refine Synthesis & Verification:**
    *   Continuously iterate on `writer_agent` and `financial_data_agent` prompts based on test results to improve synthesis quality, especially focusing on drawing connections between news, trades, ownership, and financials.
    *   Revisit `verifier_agent`: Can its prompt be improved to check for correlations mentioned by the writer? Can it specifically validate claims against the structured data passed through (though this might be hard for the LLM)?

### Phase 3: Web Interface Integration (using Streamlit)

8.  **Setup Streamlit App:**
    *   Create `requirements.txt` if needed (add `streamlit`).
    *   Create basic `streamlit_app.py`.

9.  **Develop Core Web App:**
    *   **UI**: Simple interface with a text input for the user query, a button ('Analyze'), and a main area to display output.
    *   **Backend Logic (`streamlit_app.py`):**
        *   Import necessary agent components (`FinancialResearchManager`).
        *   On button click:
            *   Display a loading/progress indicator.
            *   Instantiate `FinancialResearchManager`.
            *   Run `manager.run(query)` asynchronously (using `asyncio.run()` or Streamlit's async handling).
            *   Capture the final report components (Markdown report text, possibly structured data separately if easier). 
            *   *Note*: Need a way to capture `printer.py` updates for status messages in Streamlit (e.g., pass a callback function or queue to the `Printer` class).
    *   **Display**: Render the generated Markdown report in the Streamlit app using `st.markdown()`. 

10. **Integrate Chart Visualization:**
    *   **Parsing**: In `streamlit_app.py`, after getting the report, implement logic to find and parse the CSV/JSON data embedded within the Markdown code blocks.
    *   **Charting**: Use a library like `streamlit.line_chart`, `streamlit.bar_chart`, `plotly`, or `altair` to generate interactive charts from the parsed data (e.g., stock price trend, historical revenue/metric trends).
    *   **Display**: Display the generated charts within the Streamlit app, potentially using columns or expanders (`st.columns`, `st.expander`) alongside the text report.

11. **Deployment (Optional):**
    *   Prepare for deployment (e.g., ensure requirements are listed).
    *   Deploy using Streamlit Community Cloud or another platform.

12. **Testing:** Thoroughly test the web application workflow, including chart generation and responsiveness. 